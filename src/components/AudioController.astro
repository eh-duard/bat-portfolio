---
interface Props {
  ambientVolume?: number;
  effectVolume?: number;
}

const { 
  ambientVolume = 0.3,
  effectVolume = 0.5 
} = Astro.props;

const baseUrl = import.meta.env.BASE_URL.endsWith('/') 
  ? import.meta.env.BASE_URL 
  : import.meta.env.BASE_URL + '/';
---

<!-- Audio Gate - shown at start -->
<div id="audio-gate" class="audio-gate">
  <div class="gate-content">
    <div class="gate-icon">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M11 5L6 9H2v6h4l5 4V5z"/>
        <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/>
      </svg>
    </div>
    <p class="gate-text">Esperienza audio immersiva</p>
    <div class="gate-buttons">
      <button id="audio-enable" class="gate-btn gate-btn-primary">
        Attiva Audio
      </button>
      <button id="audio-skip" class="gate-btn gate-btn-secondary">
        Continua senza
      </button>
    </div>
  </div>
</div>

<!-- Audio Toggle Button (bottom right) -->
<div id="audio-controller" class="audio-controller hidden">
  <button 
    id="audio-toggle" 
    class="audio-toggle muted" 
    aria-label="Toggle audio"
    title="Toggle audio"
  >
    <svg class="icon-sound-on" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M11 5L6 9H2v6h4l5 4V5z"/>
      <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/>
    </svg>
    <svg class="icon-sound-off" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M11 5L6 9H2v6h4l5 4V5z"/>
      <line x1="23" y1="9" x2="17" y2="15"/>
      <line x1="17" y1="9" x2="23" y2="15"/>
    </svg>
  </button>
</div>

<audio id="ambient-audio" loop preload="auto">
  <source src={`${baseUrl}sounds/ambient.mp3`} type="audio/mpeg" />
</audio>

<audio id="ambient-audio-2" loop preload="auto">
  <source src={`${baseUrl}sounds/ambient.mp3`} type="audio/mpeg" />
</audio>

<audio id="found-audio" preload="auto">
  <source src={`${baseUrl}sounds/found.mp3`} type="audio/mpeg" />
</audio>

<style>
  /* Audio Gate Overlay */
  .audio-gate {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-bg-primary);
    z-index: calc(var(--z-audio) + 100);
    transition: opacity 0.5s ease, visibility 0.5s ease;
    overflow: hidden;
    touch-action: none;
  }

  .audio-gate.hidden {
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
  }

  .gate-content {
    text-align: center;
    padding: var(--space-xl);
  }

  .gate-icon {
    width: 80px;
    height: 80px;
    margin: 0 auto var(--space-lg);
    color: var(--color-accent);
    animation: pulse-glow 2s ease-in-out infinite;
  }

  .gate-icon svg {
    width: 100%;
    height: 100%;
  }

  @keyframes pulse-glow {
    0%, 100% { 
      opacity: 0.6;
      filter: drop-shadow(0 0 10px var(--color-accent-dim));
    }
    50% { 
      opacity: 1;
      filter: drop-shadow(0 0 20px var(--color-accent));
    }
  }

  .gate-text {
    font-family: var(--font-display);
    font-size: clamp(1rem, 3vw, 1.5rem);
    color: var(--color-text-secondary);
    margin-bottom: var(--space-lg);
    letter-spacing: 0.1em;
  }

  .gate-buttons {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
    max-width: 250px;
    margin: 0 auto;
  }

  .gate-btn {
    padding: var(--space-md) var(--space-lg);
    font-family: var(--font-display);
    font-size: 1rem;
    letter-spacing: 0.05em;
    border-radius: 4px;
    cursor: pointer;
    transition: all var(--transition-fast);
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
    user-select: none;
  }

  .gate-btn-primary {
    background: var(--color-accent);
    color: var(--color-bg-primary);
    border: 2px solid var(--color-accent);
  }

  .gate-btn-primary:hover,
  .gate-btn-primary:active {
    background: var(--color-accent-hover);
    border-color: var(--color-accent-hover);
    transform: scale(1.02);
  }

  .gate-btn-secondary {
    background: transparent;
    color: var(--color-text-muted);
    border: 1px solid var(--color-text-muted);
  }

  .gate-btn-secondary:hover,
  .gate-btn-secondary:active {
    color: var(--color-text-secondary);
    border-color: var(--color-text-secondary);
  }

  /* Audio Controller */
  .audio-controller {
    position: fixed;
    bottom: var(--space-md);
    right: var(--space-md);
    z-index: var(--z-audio);
    transition: opacity 0.3s ease, visibility 0.3s ease;
  }

  .audio-controller.hidden {
    opacity: 0;
    visibility: hidden;
  }

  .audio-toggle {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 48px;
    height: 48px;
    padding: 0;
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-accent-dim);
    border-radius: 50%;
    color: var(--color-accent);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .audio-toggle:hover {
    background: var(--color-bg-tertiary);
    border-color: var(--color-accent);
    transform: scale(1.05);
  }

  .audio-toggle svg {
    width: 24px;
    height: 24px;
  }

  .audio-toggle .icon-sound-off {
    display: none;
  }

  .audio-toggle.muted .icon-sound-on {
    display: none;
  }

  .audio-toggle.muted .icon-sound-off {
    display: block;
  }
</style>

<script define:vars={{ ambientVolume, effectVolume }}>
  class AudioController {
    constructor() {
      this.gate = document.getElementById('audio-gate');
      this.enableBtn = document.getElementById('audio-enable');
      this.skipBtn = document.getElementById('audio-skip');
      this.controller = document.getElementById('audio-controller');
      this.toggleBtn = document.getElementById('audio-toggle');
      this.ambientAudio = document.getElementById('ambient-audio');
      this.ambientAudio2 = document.getElementById('ambient-audio-2');
      this.foundAudio = document.getElementById('found-audio');
      
      this.isMuted = true;
      this.crossfadeInterval = null;
      
      this.ambientAudio.volume = ambientVolume;
      this.ambientAudio2.volume = 0;
      this.foundAudio.volume = effectVolume;
      
      this.init();
    }

    init() {
      this.bindEvents();
      this.setupCrossfade();
    }

    setupCrossfade() {
      // When first audio is about to end, start crossfade to second
      this.ambientAudio.addEventListener('timeupdate', () => {
        const timeLeft = this.ambientAudio.duration - this.ambientAudio.currentTime;
        if (timeLeft <= 1 && timeLeft > 0 && !this.isMuted && this.ambientAudio2.paused) {
          this.startCrossfade(this.ambientAudio, this.ambientAudio2);
        }
      });
      
      this.ambientAudio2.addEventListener('timeupdate', () => {
        const timeLeft = this.ambientAudio2.duration - this.ambientAudio2.currentTime;
        if (timeLeft <= 1 && timeLeft > 0 && !this.isMuted && this.ambientAudio.paused) {
          this.startCrossfade(this.ambientAudio2, this.ambientAudio);
        }
      });
    }

    startCrossfade(fromAudio, toAudio) {
      toAudio.currentTime = 0;
      toAudio.volume = 0;
      toAudio.play().catch(() => {});
      
      const fadeStep = 0.05;
      const fadeInterval = 50; // 50ms steps = 1 sec total fade
      
      const fade = setInterval(() => {
        if (fromAudio.volume > fadeStep) {
          fromAudio.volume -= fadeStep;
        } else {
          fromAudio.volume = 0;
          fromAudio.pause();
        }
        
        if (toAudio.volume < ambientVolume - fadeStep) {
          toAudio.volume += fadeStep;
        } else {
          toAudio.volume = ambientVolume;
          clearInterval(fade);
        }
      }, fadeInterval);
    }

    bindEvents() {
      this.enableBtn.addEventListener('click', () => this.startWithAudio());
      this.skipBtn.addEventListener('click', () => this.startWithoutAudio());
      this.toggleBtn.addEventListener('click', () => this.toggle());
      
      document.addEventListener('logo-found', () => this.playFoundSound());
    }

    startWithAudio() {
      this.isMuted = false;
      this.hideGate();
      
      // Unlock ALL audio elements on user interaction (required for iOS/mobile)
      this.foundAudio.play().then(() => {
        this.foundAudio.pause();
        this.foundAudio.currentTime = 0;
      }).catch(() => {});
      
      this.ambientAudio2.play().then(() => {
        this.ambientAudio2.pause();
        this.ambientAudio2.currentTime = 0;
      }).catch(() => {});
      
      this.playAmbient();
      this.updateUI();
    }

    startWithoutAudio() {
      this.isMuted = true;
      this.hideGate();
      this.updateUI();
    }

    hideGate() {
      this.gate.classList.add('hidden');
      this.controller.classList.remove('hidden');
    }

    toggle() {
      this.isMuted = !this.isMuted;
      this.updateUI();
      
      if (this.isMuted) {
        this.ambientAudio.pause();
        this.ambientAudio2.pause();
      } else {
        this.playAmbient();
      }
    }

    updateUI() {
      this.toggleBtn.classList.toggle('muted', this.isMuted);
    }

    playAmbient() {
      this.ambientAudio.volume = ambientVolume;
      this.ambientAudio.play().catch(() => {});
    }

    playFoundSound() {
      if (this.isMuted) return;
      
      // Stop ambient immediately
      this.ambientAudio.pause();
      this.ambientAudio.currentTime = 0;
      this.ambientAudio.volume = ambientVolume;
      this.ambientAudio2.pause();
      this.ambientAudio2.currentTime = 0;
      this.ambientAudio2.volume = 0;
      
      // Play found effect
      this.foundAudio.currentTime = 0;
      this.foundAudio.play().catch(() => {});
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    new AudioController();
  });
</script>
