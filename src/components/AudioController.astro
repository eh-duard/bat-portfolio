---
interface Props {
  ambientVolume?: number;
  effectVolume?: number;
  titleText?: string;
  enableText?: string;
  skipText?: string;
}

const { 
  ambientVolume = 0.3,
  effectVolume = 0.5,
  titleText = 'Esperienza audio immersiva',
  enableText = 'Attiva Audio',
  skipText = 'Continua senza'
} = Astro.props;

const baseUrl = import.meta.env.BASE_URL.endsWith('/') 
  ? import.meta.env.BASE_URL 
  : import.meta.env.BASE_URL + '/';
---

<!-- Audio Gate - shown at start -->
<!-- Audio Gate - shown at start -->
<div id="audio-gate" class="fixed inset-0 flex items-center justify-center bg-black z-[600] transition-all duration-700">
  <!-- Dynamic Background with Scanlines -->
  <div class="absolute inset-0 bg-[radial-gradient(circle_at_center,_rgba(20,20,20,0)_0%,_rgba(0,0,0,1)_120%)] z-10"></div>
  <div class="absolute inset-0 bg-[url('/bat-portfolio/scanlines.svg')] opacity-30 pointer-events-none z-0"></div>
  <div class="absolute inset-0 bg-[url('/bat-portfolio/grid.svg')] opacity-20 pointer-events-none z-0 mask-image-gradient"></div>
  
  <div class="relative z-20 text-center p-6 md:p-12 bg-[#050505]/95 border border-white/10 backdrop-blur-2xl rounded-lg shadow-[0_0_80px_rgba(0,0,0,0.9)] max-w-sm md:max-w-md w-[90%] md:w-full mx-auto animate-fade-in-up overflow-hidden group">
    
    <!-- Decorative Tech Corners -->
    <div class="absolute top-0 left-0 w-6 h-6 border-t-2 border-l-2 border-[#ffd700] opacity-80"></div>
    <div class="absolute top-0 right-0 w-6 h-6 border-t-2 border-r-2 border-[#ffd700] opacity-80"></div>
    <div class="absolute bottom-0 left-0 w-6 h-6 border-b-2 border-l-2 border-[#ffd700] opacity-80"></div>
    <div class="absolute bottom-0 right-0 w-6 h-6 border-b-2 border-r-2 border-[#ffd700] opacity-80"></div>

    <!-- Scanner Line Animation -->
    <div class="absolute inset-x-0 h-[2px] bg-[#ffd700]/30 top-0 animate-scanline"></div>

    <!-- Icon -->
    <div class="relative w-20 h-20 md:w-24 md:h-24 mx-auto mb-8 md:mb-12 text-[#ffd700] flex items-center justify-center group-hover:scale-110 transition-transform duration-500">
       <div class="absolute inset-0 bg-[#ffd700] blur-[50px] opacity-20 animate-pulse-slow"></div>
       
       <!-- Rotating Ring -->
       <svg viewBox="0 0 24 24" fill="none" class="absolute inset-0 w-full h-full animate-spin-slow opacity-30">
          <circle cx="12" cy="12" r="11" stroke="currentColor" stroke-width="0.5" stroke-dasharray="4 4" />
          <circle cx="12" cy="12" r="8" stroke="currentColor" stroke-width="0.2" />
       </svg>

       <!-- Static Icon (Scaled Down) -->
       <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="w-10 h-10 md:w-12 md:h-12 drop-shadow-[0_0_15px_rgba(255,215,0,0.8)] relative z-10">
         <path d="M11 5L6 9H2v6h4l5 4V5z" fill="currentColor" fill-opacity="0.2"/>
         <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/>
       </svg>
    </div>

    <!-- Title -->
    <h2 class="font-display text-2xl md:text-3xl text-white mb-3 tracking-[0.25em] uppercase drop-shadow-md" data-i18n="audio.system">
      Audio Experience
    </h2>
    <div class="w-12 h-0.5 bg-[#ffd700] mx-auto mb-8 opacity-70"></div>

    <p class="font-mono text-xs text-gray-400 mb-8 md:mb-12 leading-relaxed max-w-xs mx-auto tracking-wide">
      <span data-i18n="audio.init">INITIALIZING AUDIO SYSTEM...</span><br>
      <span class="text-[#ffd700]/60" data-i18n="audio.immersion">RECOMMENDED FOR FULL EXPERIENCE</span>
    </p>

    <!-- Buttons -->
    <div class="flex flex-col gap-5 items-center w-full">
      <button id="audio-enable" class="group/btn relative w-full py-4 bg-[#ffd700] text-black font-bold uppercase tracking-[0.2em] hover:bg-[#ffed4a] transition-all duration-300 clip-path-button hover:shadow-[0_0_30px_rgba(255,215,0,0.5)]">
        <span class="relative z-10 flex items-center justify-center gap-3">
           <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"></path></svg>
           <span data-i18n="audio.enable">{enableText}</span>
        </span>
      </button>
      
      <button id="audio-skip" class="w-full py-3 border border-white/10 text-xs font-mono text-gray-500 hover:text-white hover:border-white/30 hover:bg-white/5 uppercase tracking-widest transition-all duration-300 rounded-sm">
        <span data-i18n="audio.skip">{skipText}</span>
      </button>
    </div>
  </div>
</div>

<!-- Audio Toggle / Scroll To Top Button -->
<div id="audio-controller" class="fixed bottom-6 right-6 z-[500] transition-all duration-300 opacity-0 translate-y-10">
  <button 
    id="action-btn"
    class="group relative w-12 h-12 rounded-full border border-[#ffd700] flex items-center justify-center transition-all duration-300 hover:bg-[#ffd700] hover:scale-110 hover:shadow-[0_0_20px_rgba(255,215,0,0.4)] text-[#ffd700] hover:text-black"
    aria-label="Toggle Audio / Scroll to Top"
  >
    <!-- Sound On Icon -->
    <svg id="icon-sound-on" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 transition-colors" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M11 5L6 9H2v6h4l5 4V5z"></path>
      <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
    </svg>

    <!-- Sound Off Icon -->
    <svg id="icon-sound-off" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 hidden transition-colors" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <line x1="1" y1="1" x2="23" y2="23"></line>
      <path d="M9 9v3a3 3 0 0 0 5.12 2.12M15.5 15.5a5 5 0 0 1-7 0V9"></path>
      <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
      <path d="M11 5L6 9H2v6h4l5 4V5z"></path>
    </svg>

    <!-- Scroll Top Icon -->
    <svg id="icon-scroll-top" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 hidden transition-colors" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M18 15l-6-6-6 6"/>
    </svg>
  </button>
</div>

<audio id="ambient-audio" loop preload="auto">
  <source src={`${baseUrl}sounds/ambient.mp3`} type="audio/mpeg" />
</audio>

<audio id="ambient-audio-2" loop preload="auto">
  <source src={`${baseUrl}sounds/ambient.mp3`} type="audio/mpeg" />
</audio>

<audio id="found-audio" preload="auto">
  <source src={`${baseUrl}sounds/found.mp3`} type="audio/mpeg" />
</audio>

<!-- Hidden settings element to pass props -->
<div id="audio-settings" data-ambient={ambientVolume} data-effect={effectVolume} class="hidden"></div>

<script>
  import { gameStore } from '../stores/gameStore';

  class AudioController {
    gate: HTMLElement | null;
    enableBtn: HTMLElement | null;
    skipBtn: HTMLElement | null;
    controller: HTMLElement | null;
    actionBtn: HTMLElement | null;
    iconSoundOn: HTMLElement | null;
    iconSoundOff: HTMLElement | null;
    iconScrollTop: HTMLElement | null;
    ambientAudio: HTMLAudioElement | null;
    ambientAudio2: HTMLAudioElement | null;
    foundAudio: HTMLAudioElement | null;
    isMuted: boolean;
    isRevealed: boolean;
    isReady: boolean;
    isUnlocking: boolean;
    hasFoundLogo: boolean;
    crossfadeTimeout: any;
    crossfadePending: boolean;
    ambientVolume: number;
    effectVolume: number;

    constructor() {
      // Get props from data attributes
      const settings = document.getElementById('audio-settings');
      this.ambientVolume = Number(settings?.dataset.ambient || 0.3);
      this.effectVolume = Number(settings?.dataset.effect || 0.5);

      this.gate = document.getElementById('audio-gate');
      this.enableBtn = document.getElementById('audio-enable');
      this.skipBtn = document.getElementById('audio-skip');
      this.controller = document.getElementById('audio-controller');
      this.actionBtn = document.getElementById('action-btn');
      
      this.iconSoundOn = document.getElementById('icon-sound-on');
      this.iconSoundOff = document.getElementById('icon-sound-off');
      this.iconScrollTop = document.getElementById('icon-scroll-top');

      this.ambientAudio = document.getElementById('ambient-audio') as HTMLAudioElement;
      this.ambientAudio2 = document.getElementById('ambient-audio-2') as HTMLAudioElement;
      this.foundAudio = document.getElementById('found-audio') as HTMLAudioElement;
      
      this.isMuted = true;
      this.isRevealed = false;
      
      this.isReady = false;
      this.isUnlocking = false;
      this.hasFoundLogo = false;
      this.crossfadeTimeout = null;
      this.crossfadePending = false;
      
      // Initialize volumes
      if(this.ambientAudio) this.ambientAudio.volume = this.ambientVolume;
      if(this.ambientAudio2) this.ambientAudio2.volume = 0;
      if(this.foundAudio) this.foundAudio.volume = this.effectVolume;
      
      this.init();
    }

    init() {
      if (!this.enableBtn || !this.skipBtn) return;
      this.bindEvents();
      this.setupCrossfade();
      
      // Subscribe to store for reveal state
      gameStore.subscribe(state => {
        if (state.isRevealed && !this.isRevealed) {
            this.setScrollMode();
        }
      });

      // Fallback: detect scroll past spotlight to enable scroll mode
      this.setupScrollDetection();
    }

    setupScrollDetection() {
      // Simple approach: always show scroll button after portfolio is revealed
      // Listen for the gameStore reveal event which is the primary trigger
      
      // Also listen for scroll to show button when user scrolls down
      let scrollTimeout: any = null;
      window.addEventListener('scroll', () => {
        if (scrollTimeout) clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(() => {
          if (window.scrollY > 100) {
            this.showScrollButton();
          }
        }, 100);
      }, { passive: true });
    }

    showScrollButton() {
      if (this.isRevealed) return; // Already in scroll mode
      this.isRevealed = true;
      
      // Hide sound icons, show scroll icon
      this.iconSoundOn?.classList.add('hidden');
      this.iconSoundOff?.classList.add('hidden');
      this.iconScrollTop?.classList.remove('hidden');
      
      // Reset styles
      this.actionBtn?.classList.remove('border-red-500', 'text-red-500');
      this.actionBtn?.classList.add('border-[#ffd700]', 'text-[#ffd700]');
      
      // Show the controller
      this.controller?.classList.remove('opacity-0', 'translate-y-10', 'hidden');
    }

    bindEvents() {
      this.enableBtn.addEventListener('click', () => this.startWithAudio());
      this.skipBtn.addEventListener('click', () => this.startWithoutAudio());
      
      // Dual logic for button
      this.actionBtn?.addEventListener('click', () => {
         if (this.isRevealed) {
             window.scrollTo({ top: 0, behavior: 'smooth' });
         } else {
             this.toggleAudio();
         }
      });
      
      document.addEventListener('logo-found', () => this.playFoundSound());
    }

    setScrollMode() {
        this.showScrollButton();
    }

    updateAudioIcons() {
        if (this.isRevealed) return; // Don't mess with icons if in scroll mode

        if (this.isMuted) {
            this.iconSoundOn?.classList.add('hidden');
            this.iconSoundOff?.classList.remove('hidden');
            this.actionBtn?.classList.add('border-red-500', 'text-red-500');
            this.actionBtn?.classList.remove('text-[#ffd700]');
        } else {
            this.iconSoundOn?.classList.remove('hidden');
            this.iconSoundOff?.classList.add('hidden');
            this.actionBtn?.classList.remove('border-red-500', 'text-red-500');
            this.actionBtn?.classList.add('text-[#ffd700]');
        }
    }

    startWithAudio() {
      if (!this.foundAudio || !this.ambientAudio2) return;
      
      this.isMuted = false;
      this.isUnlocking = true;
      this.hideGate();
      
      const originalFoundVolume = this.effectVolume;
      this.foundAudio.volume = 0;
      this.ambientAudio2.volume = 0;
      
      let unlockCount = 0;
      const checkUnlockComplete = () => {
        unlockCount++;
        if (unlockCount >= 2) {
          this.isUnlocking = false;
          this.isReady = true;
        }
      };
      
      // Pre-load/unlock audio context
      this.foundAudio.play().then(() => {
        if(this.foundAudio) {
            this.foundAudio.pause();
            this.foundAudio.currentTime = 0;
            this.foundAudio.volume = originalFoundVolume;
        }
        checkUnlockComplete();
      }).catch(() => checkUnlockComplete());
      
      this.ambientAudio2.play().then(() => {
        if (this.ambientAudio2) {
            this.ambientAudio2.pause();
            this.ambientAudio2.currentTime = 0;
        }
        checkUnlockComplete();
      }).catch(() => checkUnlockComplete());
      
      this.playAmbient();
      this.updateAudioIcons();
    }

    startWithoutAudio() {
      this.isMuted = true;
      this.isReady = true;
      this.hideGate();
      this.updateAudioIcons();
    }

    hideGate() {
      this.gate?.classList.add('opacity-0', 'pointer-events-none');
      setTimeout(() => {
          this.gate?.classList.add('hidden');
          // Show controller
          this.controller?.classList.remove('opacity-0', 'translate-y-10');
      }, 500);
    }

    toggleAudio() {
      this.isMuted = !this.isMuted;
      this.updateAudioIcons();
      
      if (this.isMuted) {
        this.ambientAudio?.pause();
        this.ambientAudio2?.pause();
      } else {
        this.playAmbient();
      }
    }

    playAmbient() {
      if (!this.ambientAudio) return;
      this.ambientAudio.volume = this.ambientVolume;
      this.ambientAudio.play().catch(() => {});
    }

    playFoundSound() {
      if (this.isMuted || !this.isReady || this.isUnlocking || this.hasFoundLogo || !this.ambientAudio || !this.ambientAudio2 || !this.foundAudio) return;
      
      this.hasFoundLogo = true;
      
      this.ambientAudio.pause();
      this.ambientAudio.currentTime = 0;
      this.foundAudio.currentTime = 0;
      this.foundAudio.play().catch(() => {});
    }

    setupCrossfade() {
      if (!this.ambientAudio || !this.ambientAudio2) return;

      this.ambientAudio.addEventListener('timeupdate', () => {
        if (this.crossfadePending || !this.ambientAudio || !this.ambientAudio2) return;
        const timeLeft = this.ambientAudio.duration - this.ambientAudio.currentTime;
        if (timeLeft <= 1 && timeLeft > 0 && !this.isMuted && this.ambientAudio2.paused) {
          this.crossfadePending = true;
          clearTimeout(this.crossfadeTimeout);
          this.crossfadeTimeout = setTimeout(() => {
            if(this.ambientAudio && this.ambientAudio2) 
                this.startCrossfade(this.ambientAudio, this.ambientAudio2);
            this.crossfadePending = false;
          }, 100);
        }
      });
      
      this.ambientAudio2.addEventListener('timeupdate', () => {
        if (this.crossfadePending || !this.ambientAudio || !this.ambientAudio2) return;
        const timeLeft = this.ambientAudio2.duration - this.ambientAudio2.currentTime;
        if (timeLeft <= 1 && timeLeft > 0 && !this.isMuted && this.ambientAudio.paused) {
          this.crossfadePending = true;
          clearTimeout(this.crossfadeTimeout);
          this.crossfadeTimeout = setTimeout(() => {
            if (this.ambientAudio2 && this.ambientAudio)
                this.startCrossfade(this.ambientAudio2, this.ambientAudio);
            this.crossfadePending = false;
          }, 100);
        }
      });
    }

    startCrossfade(fromAudio: HTMLAudioElement, toAudio: HTMLAudioElement) {
      toAudio.currentTime = 0;
      toAudio.volume = 0;
      toAudio.play().catch(() => {});
      
      const fadeStep = 0.05;
      const fadeInterval = 50;
      
      const fade = setInterval(() => {
        if (fromAudio.volume > fadeStep) {
          fromAudio.volume -= fadeStep;
        } else {
          fromAudio.volume = 0;
          fromAudio.pause();
        }
        
        if (toAudio.volume < this.ambientVolume - fadeStep) {
          toAudio.volume += fadeStep;
        } else {
          toAudio.volume = this.ambientVolume;
          clearInterval(fade);
        }
      }, fadeInterval);
    }
  }

  // Clean listeners to avoid duplication on page swap if framework handles it
  const init = () => {
    new AudioController();
  };

  document.addEventListener('astro:page-load', init);
  document.addEventListener('DOMContentLoaded', init);
</script>

<style>
  /* Optional Text Shadow utility if not in global */
  .text-shadow-sm { text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
</style>

