---
interface Props {
  currentLang?: 'it' | 'en';
}

const { currentLang = 'it' } = Astro.props;
---

<nav id="main-nav" class="navigation" aria-label="Main navigation">
  <div class="nav-container">
    <a href="#" class="nav-logo" aria-label="Home">
      <span class="logo-text">EP</span>
    </a>

    <div class="nav-controls">
      <!-- Language Switch -->
      <div class="lang-switch" role="group" aria-label="Language selection">
        <button 
          class={`lang-btn ${currentLang === 'it' ? 'active' : ''}`}
          data-lang="it"
          aria-pressed={currentLang === 'it'}
        >
          IT
        </button>
        <span class="lang-divider">/</span>
        <button 
          class={`lang-btn ${currentLang === 'en' ? 'active' : ''}`}
          data-lang="en"
          aria-pressed={currentLang === 'en'}
        >
          EN
        </button>
      </div>

      <!-- Theme Toggle -->
      <button 
        id="theme-toggle" 
        class="theme-toggle" 
        aria-label="Toggle theme"
        title="Toggle dark/light mode"
      >
        <svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="5"/>
          <line x1="12" y1="1" x2="12" y2="3"/>
          <line x1="12" y1="21" x2="12" y2="23"/>
          <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
          <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
          <line x1="1" y1="12" x2="3" y2="12"/>
          <line x1="21" y1="12" x2="23" y2="12"/>
          <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
          <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
        </svg>
        <svg class="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
        </svg>
      </button>
    </div>
  </div>
</nav>

<style>
  .navigation {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: var(--z-sticky);
    padding: var(--space-md) var(--space-lg);
    background: linear-gradient(
      to bottom,
      var(--color-bg-primary) 0%,
      transparent 100%
    );
    opacity: 0;
    transform: translateY(-20px);
    transition: opacity 0.5s ease, transform 0.5s ease;
    pointer-events: none;
  }

  .navigation.visible {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
  }

  .nav-container {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .nav-logo {
    text-decoration: none;
  }

  .logo-text {
    font-family: var(--font-display);
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--color-accent);
    letter-spacing: 0.1em;
    transition: color var(--transition-fast);
  }

  .nav-logo:hover .logo-text {
    color: var(--color-accent-hover);
  }

  .nav-controls {
    display: flex;
    align-items: center;
    gap: var(--space-md);
  }

  /* Language Switch */
  .lang-switch {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
  }

  .lang-btn {
    background: none;
    border: none;
    padding: var(--space-xs) var(--space-sm);
    font-family: var(--font-display);
    font-size: 0.875rem;
    color: var(--color-text-muted);
    cursor: pointer;
    transition: color var(--transition-fast);
  }

  .lang-btn:hover {
    color: var(--color-text-secondary);
  }

  .lang-btn.active {
    color: var(--color-accent);
  }

  .lang-divider {
    color: var(--color-text-muted);
    font-size: 0.875rem;
  }

  /* Theme Toggle */
  .theme-toggle {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    padding: 0;
    background: transparent;
    border: 1px solid var(--color-text-muted);
    border-radius: 50%;
    color: var(--color-text-secondary);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .theme-toggle:hover {
    border-color: var(--color-accent);
    color: var(--color-accent);
  }

  .theme-toggle svg {
    width: 20px;
    height: 20px;
  }

  /* Dark mode (default): show moon, hide sun */
  .theme-toggle .icon-sun {
    display: none;
  }

  .theme-toggle .icon-moon {
    display: block;
  }

  /* Light mode: show sun, hide moon */
  :global([data-theme="light"]) .theme-toggle .icon-sun {
    display: block;
  }

  :global([data-theme="light"]) .theme-toggle .icon-moon {
    display: none;
  }
</style>

<script>
  class Navigation {
    private nav: HTMLElement;
    private themeToggle: HTMLElement;
    private langBtns: NodeListOf<HTMLElement>;

    constructor() {
      this.nav = document.getElementById('main-nav')!;
      this.themeToggle = document.getElementById('theme-toggle')!;
      this.langBtns = document.querySelectorAll('.lang-btn');
      
      this.init();
    }

    private init() {
      this.bindEvents();
    }

    private bindEvents() {
      // Show nav after intro complete
      document.addEventListener('spotlight-complete', () => {
        this.nav.classList.add('visible');
      });

      // Theme toggle
      this.themeToggle.addEventListener('click', () => this.toggleTheme());

      // Language switch
      this.langBtns.forEach(btn => {
        btn.addEventListener('click', () => this.switchLang(btn.dataset.lang as 'it' | 'en'));
      });
    }

    private toggleTheme() {
      const html = document.documentElement;
      const currentTheme = html.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      
      html.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
    }

    private switchLang(lang: 'it' | 'en') {
      // Update UI
      this.langBtns.forEach(btn => {
        const isActive = btn.dataset.lang === lang;
        btn.classList.toggle('active', isActive);
        btn.setAttribute('aria-pressed', String(isActive));
      });

      // Store preference
      localStorage.setItem('lang', lang);

      // Dispatch event for i18n system
      document.dispatchEvent(new CustomEvent('lang-change', { detail: { lang } }));
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    new Navigation();
  });
</script>
